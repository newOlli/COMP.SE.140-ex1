stages:
  - build
  - test
  - deploy

variables:
  DOCKER_IMAGE_NGINX: nginx-app
  DOCKER_IMAGE_SERVICE1: service1
  DOCKER_IMAGE_SERVICE2: service2
  DOCKER_IMAGE_SHUTDOWN: shutdown-service
  DOCKER_TAG: latest

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $DOCKER_IMAGE_NGINX:$DOCKER_TAG ./nginx
    - docker build -t $DOCKER_IMAGE_SERVICE1:$DOCKER_TAG ./service1
    - docker build -t $DOCKER_IMAGE_SERVICE2:$DOCKER_TAG ./service2
    - docker build -t $DOCKER_IMAGE_SHUTDOWN:$DOCKER_TAG ./shutdown-service

test:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Testing Nginx configuration"
    - docker run --rm $DOCKER_IMAGE_NGINX:$DOCKER_TAG nginx -t
    - echo "Running tests for service1"
    - docker run --rm $DOCKER_IMAGE_SERVICE1:$DOCKER_TAG node --version
    - echo "Running tests for service2"
    - docker run --rm $DOCKER_IMAGE_SERVICE2:$DOCKER_TAG python --version

deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker-compose down
    - docker-compose up -d
  only:
    - project
